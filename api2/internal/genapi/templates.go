package main

import (
	"bytes"
	"fmt"
	"io/ioutil"
	"os"
	"path/filepath"
	"text/template"
)

func fillTemplates() {
	for _, in := range inputStructs {
		outBuf := new(bytes.Buffer)
		input := struct {
			Name    string
			Package string
			Fields  []fieldInfo
		}{
			Name:    in.generatedStructure.name,
			Package: in.generatedStructure.pkg,
			Fields:  in.generatedStructure.fields,
		}

		structTemplate.Execute(outBuf, input)

		for _, t := range in.templates {
			t.Execute(outBuf, input)
		}

		outFile, err := filepath.Abs(in.outFile)
		if err != nil {
			fmt.Printf("error opening file %q: %v\n", in.outFile, err)
			os.Exit(1)
		}
		outDir := filepath.Dir(outFile)
		if _, err := os.Stat(outDir); os.IsNotExist(err) {
			_ = os.Mkdir(outDir, os.ModePerm)
		}
		if err := ioutil.WriteFile(outFile, outBuf.Bytes(), 0644); err != nil {
			fmt.Printf("error writing file %q: %v\n", outFile, err)
			os.Exit(1)
		}
	}
}

func listTemplate(path string) *template.Template {
	return template.Must(template.New("").Parse(
		fmt.Sprint(`
func (s *{{ .Name }}Client) List(ctx context.Context, opts... api.Option) ([]{{ .Name }}, *api.Error, error) {
	if s.client == nil {
		return nil, nil, fmt.Errorf("nil client")
	}

	req, err := s.client.NewRequest(ctx, "GET", "`, path, `", nil, opts...)
	if err != nil {
		return nil, nil, fmt.Errorf("error creating List request: %w", err)
	}

	resp, err := s.client.Do(req)
	if err != nil {
		return nil, nil, fmt.Errorf("error performing client request during List call: %w", err)
	}

	type listResponse struct {
		Items []{{ .Name }}
	}
	target := &listResponse{}
	apiErr, err := resp.Decode(target)
	if err != nil {
		return nil, nil, fmt.Errorf("error decoding List response: %w", err)
	}

	return target.Items, apiErr, nil
}
`)))
}

func readTemplate(path string) *template.Template {
	return template.Must(template.New("").Parse(
		fmt.Sprint(`
func (s *{{ .Name }}Client) Read(ctx context.Context, id string, opts... api.Option) (*{{ .Name }}, *api.Error, error) {
	if id == "" {
		return nil, nil, fmt.Errorf("empty ID value passed into Read request")
	}

	if s.client == nil {
		return nil, nil, fmt.Errorf("nil client")
	}

	req, err := s.client.NewRequest(ctx, "GET", fmt.Sprintf("%s/%s", "`, path, `", id), nil, opts...)
	if err != nil {
		return nil, nil, fmt.Errorf("error creating Read request: %w", err)
	}

	resp, err := s.client.Do(req)
	if err != nil {
		return nil, nil, fmt.Errorf("error performing client request during Read call: %w", err)
	}

	target := new({{ .Name }})
	apiErr, err := resp.Decode(target)
	if err != nil {
		return nil, nil, fmt.Errorf("error decoding Read response: %w", err)
	}

	return target, apiErr, nil
}
`)))
}

func deleteTemplate(path string) *template.Template {
	return template.Must(template.New("").Parse(
		fmt.Sprint(`
func (s *{{ .Name }}Client) Delete(ctx context.Context, id string, opts... api.Option) (bool, *api.Error, error) {
	if id == "" {
		return false, nil, fmt.Errorf("empty ID value passed into Delete request")
	}

	if s.client == nil {
		return false, nil, fmt.Errorf("nil client")
	}

	req, err := s.client.NewRequest(ctx, "DELETE", fmt.Sprintf("%s/%s", "`, path, `", id), nil, opts...)
	if err != nil {
		return false, nil, fmt.Errorf("error creating Delete request: %w", err)
	}

	resp, err := s.client.Do(req)
	if err != nil {
		return false, nil, fmt.Errorf("error performing client request during Delete call: %w", err)
	}

	type deleteResponse struct {
		Existed bool
	}
	target := &deleteResponse{}
	apiErr, err := resp.Decode(target)
	if err != nil {
		return false, nil, fmt.Errorf("error decoding Delete response: %w", err)
	}

	return target.Existed, apiErr, nil
}
`)))
}

func createTemplate(path string) *template.Template {
	return template.Must(template.New("").Parse(
		fmt.Sprint(`
func (s *{{ .Name }}Client) Create(ctx context.Context, opts... api.Option) (*{{ .Name }}, *api.Error, error) {
	if s.client == nil {
		return nil, nil, fmt.Errorf("nil client")
	}
	r := {{ .Name }}{}
	req, err := s.client.NewRequest(ctx, "POST", "`, path, `", r, opts...)
	if err != nil {
		return nil, nil, fmt.Errorf("error creating Create request: %w", err)
	}

	resp, err := s.client.Do(req)
	if err != nil {
		return nil, nil, fmt.Errorf("error performing client request during Read call: %w", err)
	}

	target := new({{ .Name }})
	apiErr, err := resp.Decode(target)
	if err != nil {
		return nil, nil, fmt.Errorf("error decoding Create response: %w", err)
	}

	return target, apiErr, nil
}
`)))
}

var structTemplate = template.Must(template.New("").Parse(
	fmt.Sprint(`// Code generated by "make api"; DO NOT EDIT.
package {{ .Package }}

import (
	"context"
	"encoding/json"
	"strings"

	"github.com/fatih/structs"

	"github.com/hashicorp/watchtower/api"
)

type {{ .Name }} struct {
{{ range .Fields }} {{ .Name }}  {{ .FieldType }} `, "`json:\"{{ .ProtoName }},omitempty\"`", `
{{ end }}
}
`)))

var clientTemplate = template.Must(template.New("").Parse(
	fmt.Sprint(`
type {{ .Name }}Client struct {
	client *api.Client
}

func New(c *api.Client) *{{ .Name }}Client {
	return &{{ .Name }}Client{ client: c }
}
`)))
