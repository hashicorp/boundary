name: enos-ci-bootstrap-ent

# These permissions are necessary for the doormat-action to get the OIDC token
permissions:
  contents: read
  id-token: write

on:
  workflow_call:

jobs:
  bootstrap-ci-ent:
    env:
      TF_WORKSPACE: "${{ github.event.repository.name }}-ci-enos-bootstrap"
      TF_VAR_repository: ${{ github.event.repository.name }}
      TF_VAR_aws_ssh_public_key: ${{ secrets.SSH_KEY_PUBLIC_CI }}
      TF_TOKEN_app_terraform_io: ${{ secrets.TF_API_TOKEN }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v2
      - name: Assume service user role via Doormat
        uses: hashicorp/doormat-action@main
        with:
          # This role, its associated IAM policy, the allowed Github workflow
          # event types and their associated qualifiers are managed via
          # Terraform in the hashicorp/enos-ci repository. If you wish to allow
          # AWS credentials for different Github event types, workflows or
          # branches you'll need to update the role there.
          aws-role-arn: "${{ secrets.DOORMAT_SERVICE_USER_ROLE_ARN }}" # TODO: update this arn when the new ARN is in the secrets
      - name: Init Terraform
        id: tf_init
        run: |
          terraform -chdir=enos/ci/bootstrap init
      - name: Plan Terraform
        id: tf_plan
        run: |
          terraform -chdir=enos/ci/bootstrap plan
      - name: Apply Terraform
        if: ${{ github.ref == 'refs/heads/main' }}
        id: tf_apply
        run: |
          terraform -chdir=enos/ci/bootstrap apply -auto-approve
