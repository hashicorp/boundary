// +build genapi

package main

import (
	"bytes"
	"fmt"
	"io/ioutil"
	"os"
	"strings"
	"text/template"
)

type createInfo struct {
	baseType   string
	targetType string
	verb       string
	path       string
}

var createFuncs = map[string][]*createInfo{
	"hosts": {
		{
			"HostCatalog",
			"Host",
			"PUT",
			"host-catalogs/%s/hosts",
		},
		{
			"HostCatalog",
			"HostSet",
			"PUT",
			"host-catalogs/%s/host-sets",
		},
	},
}

func writeCreateFuncs() {
	for outPkg, funcs := range createFuncs {
		outFile := os.Getenv("GEN_BASEPATH") + fmt.Sprintf("/api/%s/create.gen.go", outPkg)
		outBuf := bytes.NewBuffer([]byte(fmt.Sprintf(
			`// Code generated by "make api"; DO NOT EDIT.
package %s
`, outPkg)))
		for _, createInfo := range funcs {
			createFuncTemplate.Execute(outBuf, struct {
				BaseType        string
				TargetType      string
				LowerTargetType string
				Verb            string
				Path            string
			}{
				BaseType:        createInfo.baseType,
				TargetType:      createInfo.targetType,
				LowerTargetType: strings.ToLower(createInfo.targetType),
				Verb:            createInfo.verb,
				Path:            createInfo.path,
			})
		}
		if err := ioutil.WriteFile(outFile, outBuf.Bytes(), 0644); err != nil {
			fmt.Printf("error writing file %q: %v\n", outFile, err)
			os.Exit(1)
		}
	}
}

var createFuncTemplate = template.Must(template.New("").Parse(
	`
func (s {{ .BaseType }}) Create{{ .TargetType }}(ctx context.Context, {{ .LowerTargetType }} *{{ .TargetType }}) (*{{ .TargetType }}, *api.Error, error) {
	if s.Client == nil {
		return nil, nil, fmt.Errorf("nil client in Create{{ .TargetType }} request")
	}
	if s.Id == "" {
		return nil, nil, fmt.Errorf("missing catalog ID in Create{{ .TargetType }} request")
	}

	req, err := s.Client.NewRequest(ctx, "{{ .Verb }}", fmt.Sprintf("{{ .Path }}", s.Id), {{ .LowerTargetType }})
	if err != nil {
		return nil, nil, fmt.Errorf("error creating Create{{ .TargetType }} request: %w", err)
	}

	resp, err := s.Client.Do(req)
	if err != nil {
		return nil, nil, fmt.Errorf("error performing client request during Create{{ .TargetType }} call: %w", err)
	}

	target := new({{ .TargetType }})
	apiErr, err := resp.Decode(target)
	if err != nil {
		return nil, nil, fmt.Errorf("error decoding Create{{ .TargetType }} repsonse: %w", err)
	}

	return target, apiErr, nil
}
`))
